import { useState, useEffect, useRef, useCallback } from "react";

export default function FlappyBirdGame() {
  const [wallet, setWallet] = useState("");
  const [isPlaying, setIsPlaying] = useState(false);
  const [score, setScore] = useState(0);
  const [leaderboard, setLeaderboard] = useState([]);
  const [error, setError] = useState("");
  const gameRef = useRef(null);
  const gameLoop = useRef(null);
  const pipes = useRef([]);
  const gapHeight = 120;
  const pipeWidth = 50;
  const pipeSpeed = 2;

  const startGame = useCallback(() => {
    let gravity = 0.6;
    let velocity = 0;
    let birdY = 150;
    let gameScore = 0;

    const canvas = gameRef.current;
    const ctx = canvas.getContext("2d");
    pipes.current = [];

    const createPipe = () => {
      let pipeX = canvas.width;
      let pipeHeight = Math.random() * (canvas.height - gapHeight - 50) + 50;
      pipes.current.push({ x: pipeX, height: pipeHeight });
    };

    const updateGame = () => {
      velocity += gravity;
      birdY += velocity;
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      ctx.fillStyle = "blue";
      ctx.fillRect(50, birdY, 30, 30);

      pipes.current.forEach((pipe, index) => {
        pipe.x -= pipeSpeed;
        ctx.fillStyle = "green";
        ctx.fillRect(pipe.x, 0, pipeWidth, pipe.height);
        ctx.fillRect(pipe.x, pipe.height + gapHeight, pipeWidth, canvas.height - pipe.height - gapHeight);

        if (pipe.x + pipeWidth === 50) {
          gameScore++;
        }

        if (
          (50 < pipe.x + pipeWidth && 50 + 30 > pipe.x && birdY < pipe.height) ||
          (50 < pipe.x + pipeWidth && 50 + 30 > pipe.x && birdY + 30 > pipe.height + gapHeight)
        ) {
          setScore(gameScore);
          updateLeaderboard(wallet, gameScore);
          setIsPlaying(false);
          return;
        }
      });

      pipes.current = pipes.current.filter(pipe => pipe.x + pipeWidth > 0);
      gameLoop.current = requestAnimationFrame(updateGame);
    };

    document.addEventListener("keydown", () => (velocity = -8));
    createPipe();
    gameLoop.current = requestAnimationFrame(updateGame);
    setInterval(createPipe, 2500);
  }, [wallet]);

  useEffect(() => {
    if (isPlaying) {
      startGame();
    } else {
      cancelAnimationFrame(gameLoop.current);
    }
    return () => cancelAnimationFrame(gameLoop.current);
  }, [isPlaying, startGame]);

  const updateLeaderboard = (wallet, score) => {
    setLeaderboard((prev) => [...prev, { wallet, score }].sort((a, b) => b.score - a.score));
  };

  const isValidBase58 = (address) => {
    const base58Regex = /^[123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz]+$/;
    return base58Regex.test(address) && address.length >= 32 && address.length <= 44;
  };

  const handleWalletChange = (e) => {
    const address = e.target.value;
    setWallet(address);
    setError(!isValidBase58(address) ? "ERROR INPUT VALID WALLET ADDRESS" : "");
  };

  return (
    <div className="flex flex-col items-center justify-center min-h-screen text-center">
      <div className="w-full max-w-lg">
        <p className="text-lg font-bold mb-2">
          Input your SOL wallet address to start playing, a percentage of the transactions go
          towards a prizepool which is then distributed to the top 10 wallet addresses on the
          leaderboard. Enjoy!
        </p>
        <p className="text-lg font-bold mb-2">PRESS SPACEBAR TO FLAP.</p>
        <input
          value={wallet}
          onChange={handleWalletChange}
          placeholder="Enter SOL Wallet Address"
          className="mb-2 border p-2 w-full"
        />
        {error && <p className="text-red-500">{error}</p>}
        <button
          disabled={!wallet || error}
          onClick={() => setIsPlaying(true)}
          className="bg-blue-500 text-white p-2 rounded mt-2"
        >
          Play
        </button>
      </div>
      <canvas ref={gameRef} width={400} height={300} className="border mt-4 mx-auto" />
      <div className="mt-5 w-full max-w-lg">
        <h2 className="text-lg font-bold">Leaderboard</h2>
        <ul>
          {leaderboard.map((entry, index) => (
            <li key={index} className="flex justify-between border-b py-2">
              <span>{entry.wallet}</span>
              <span>{entry.score}</span>
            </li>
          ))}
        </ul>
      </div>
    </div>
  );
}
